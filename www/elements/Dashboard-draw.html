
<dom-module id="dashboard-draw">

<template>
             
    <div id="container" style="width:100%;margin-right:10px" style="display:none">

    </div>

    <div id="loader" style="display:none"></div>
    <createHighchart-element><paper-spinner id="spinner" hidden></paper-spinner></createHighchart-element>
</template>
<script>
    var workboardData = []; //Will be used to store JSON data.
    var kettleData = [];  //Will be used to store JSON data.
    var visualData = []; //Will be used to store JSON data.
    var option = []; //Will be used for the high charts.
    var workboardColumnInfo = [];
    //var vData;
    var workboard=[];
    var visualisation=[];
    var kettle=[]; 
    var workboardDataConfiguration = [];
    var decryptedData = [];
    var kettleResultset = [];		
    var visualisationConfiguration =[];

    Polymer({
        is:"dashboard-draw",
        createDashboard:function(userId,workboard_id)
        {
            var self=this;
            //var requestData = {"data":{"workboard-id":id,"params":{}}}; 
            console.log(userId);
            console.log(workboard_id);
            self.loadingStart(); 
			spinner.active = true;
			spinner.hidden = false;
			console.log("loading start");
            $.when(
                    console.log("when block"),
					/*
                    workboardData = getWorkboardData(userId,workboard_id),
                    visualData = getVisualisationData(userId,workboard_id),
                    kettleData = getKettleData(userId,workboard_id)
					*/
					$.ajax({
						 url: "http://10.90.21.43:8888/workboard-service/getWorkboard?workboard=".concat(id),               
						 type: "POST",
						 beforeSend: function(xhr){xhr.setRequestHeader('AccessToken',localStorage.getItem("accessToken"));},
						 success: function(object)
						 { 
								   workboardData=object;     
								   // console.log(workboardData);
						 }
					  }),

					$.ajax({
						url: "http://10.90.21.43:8888/visualization-service/getVisualizationData?workboard_id=".concat(id),                
						type: "POST",
						beforeSend: function(xhr){xhr.setRequestHeader('AccessToken',localStorage.getItem("accessToken"));},
						success: function(object)
						{ 
						   visualData=object;
							//vData=object;
							//console.log(visualData);
						}
					 }),
					$.ajax({
						url: 'http://10.90.21.43:8888/kettle-service/kettle',
						type: 'POST',
						beforeSend: function(xhr){xhr.setRequestHeader('AccessToken',localStorage.getItem('accessToken'));},
						data: JSON.stringify(requestData),
						contentType: 'application/json; charset=utf-8',
						dataType: 'json',
						timeout:300000,
						async: true,
						success: function(object) 
						{
						   kettleData=object; 
						   // console.log(kettleData);
							//self.processDashboardData();
						}
					})
			).done(function(){
                     self.loadingStop();
					spinner.active = false;
					spinner.hidden = true;
                     console.log("Loading stop");
                 });
            $('#container').css("display","block");
            //self.startfunction(workboardData,visualData,kettleData);
            //console.log("I am here");
            self.createDashboard1();
        
        },
        createDashboard1:function()
        {    
            console.log("createDashboard1:function");
              var self=this;
              $.each(workboardData.data,function(index,value)
              {
               
                    workboard.push(value.configuration);
                    console.log(workboard);
                    workboardColumnInfo.push(workboardData.data[index].configuration.columnInfo);
                    $.each(visualData.data,function(i,e)
                   {
                          if(index==i)                                   
                              visualisation.push(e.configuration);
                   });                 
                   $.each(kettleData.data,function(i,e)
                   {
                          if(index==i)
                              kettle.push(e); 
                   });
                   //console.log(JSONfn.stringify(visualData[index].configuration.result));
                   option = JSONfn.stringify(visualData.data[index].configuration.result);

                    //self.processChartData(index,workboard,visualisation,kettle,option,workboardColumnInfo);             
					self.draw();
              }); 
        },
		draw: function(e){
			var self=this;
			//this.lodingStart();
			try{
				var visualization=JSONfn.parse(this.visualData);
				if(this.data.hasOwnProperty(this.dataId)&& typeof(this.data[this.dataId])=== 'object' && visualization.hasOwnProperty(this.dataId) && typeof(visualization[this.dataId]) === 'object'){
					var options = this.normalize(visualization[this.dataId],this.customPreProcessor(this.data[this.dataId].resultSet,this.configuration));
						if(typeof this.chartObj !== 'undefined' && Object.keys(this.chartObj).length){
							this.chartObj.destroy();
						}
				}
			}catch(e){
				console.log(e);
			}
		},
		customPreProcessor:function(data,temp){
			var func=new Function('data',atob(temp));
			return func(data);
		},
      processChartData:function(key,workboard,visualisation,kettle,option,workboardColumnInfo)
        {
            var self=this;
            console.log("I am in processChartData:function");
            //console.log(workboard);
            //console.log(key);
            if(workboardData.data[key].configuration.itemType=="chart-type-1"){
                //self.customPreProcessor('data',atob(workboardData[key].configuration.columnInfo));
                //var funct = new Function('data',atob(workboardData[key].configuration.columnInfo));
                console.log("i am in loop");
                options = JSONfn.stringify(visualisation[key].configuration.result)
                var div=document.createElement('paper-material');
                div.setAttribute("elevation","2");
                $(div).css("background-color","white");
                $(div).css("height","auto");                
                $(div).css("margin","10px");
                $(div).css("margin-bottom","20px");
                $(div).css("padding","5px");
                div.setAttribute("id","id"+key);
                var title = document.createElement("h3");
                title.innerHTML="Chart";
                div.appendChild(title);                
                var container=document.getElementById("container");
                container.appendChild(div);
                var id ="#id"+key;
                option = JSONfn.parse(option);
                option.chart = {};
                option.chart.renderTo=id;
                option = JSONfn.stringify(option);

                //window.alert("hdcdi");
                //document.getElementsByTagName('createHighchart-element')[0].createHighchart1('div');
                self.createHighchart(div);
            }
            else if(workboard[0].chartType=="Chart"){ 
                console.log("hello");
            }
        },
        
        createHighchart: function(div){
            window.alert("hi");
                var option = {
                    chart: {
                        renderTo: div,
                        type: 'bar'
                    },
                    title: {
                        text: 'Fruit Consumption'
                    },
                    xAxis: {
                        categories: ['Apples', 'Bananas', 'Oranges']
                    },
                    yAxis: {
                        title: {
                            text: 'Fruit eaten'
                        }
                    },
                    series: [{
                        name: 'Jane',
                        data: [1, 0, 4]
                    }, {
                        name: 'John',
                        data: [5, 7, 3]
                    }]
                };
                //console.log("I am here");
            var chart1 = new Highcharts.Chart(option);
        },

        loadingStart: function(){
            console.log("Loader function called");
            document.getElementById('loader').style.display="block";
        },
        loadingStop: function(){
            console.log("Loader function stopped");
            document.getElementById('loader').style.display="none";
        }
    })
</script>
</dom-module>